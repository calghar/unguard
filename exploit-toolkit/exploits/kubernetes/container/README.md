# Kubernetes Container Security Toolkit

A Python-based implementation of the Kubernetes Container Security Lab, offering hands-on learning for container security misconfigurations and their remediation on the *Unguard* cluster.

## üìã Overview

The toolkit provides a structured approach to understanding Kubernetes security through:

**Assessment**: Analyze security posture of deployments.
**Exploitation**: Demonstrate real attack techniques.
**Remediation**: Apply security best practices.
**Verification**: Confirm security improvements.

## üîë Features

### Detailed Risks, Impacts, and Educational Value

#### Privileged Containers

**Risk**: Complete bypass of container isolation.
**Impact**: Root access to the host system.
**Highlights**: The importance of avoiding privileged mode in container configurations.

#### Dangerous Capabilities

**Risk**: Complete container escape and host compromise.
**Impact**: Host filesystem access, kernel manipulation, and potential lateral movement.
**Highlights**: Demonstrates why Linux capabilities should be restricted to the minimum required.

#### Host Namespace Sharing

**Risk**: Access to host processes and network.
**Impact**: Lateral movement, secrets exposure, and potential privilege escalation.
**Highlights**: Emphasizes the importance of isolating container namespaces.

#### Missing Resource Limits

**Risk**: Denial of Service (DoS).
**Impact**: Node instability and service degradation.
**Highlights**: The importance of setting resource limits to prevent resource exhaustion.

### Key Capabilities

- Interactive and automated modes.
- Modular exploits with educational context.
- Flexible patching and rollback system.
- Support for all Unguard services.

## üöÄ Quick Start

### Prerequisites

- Kubernetes cluster (1.24+ recommended)
- kubectl configured with cluster access
- Helm 3.x installed
- Python 3.9+ with Poetry or pip

### Installation

#### Using Poetry

```bash
git clone <repository-url>
cd kubernetes-security-toolkit
poetry install
poetry shell
k8s-security --help
```

#### Using pip

```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\\Scripts\\activate
pip install -r requirements.txt
python -m k8ssecuritytoolkit.cli --help
```

## üõ†Ô∏è Usage

### Deploy Unguard

```bash
helm install unguard oci://ghcr.io/dynatrace-oss/unguard/chart/unguard -n unguard --create-namespace --wait

k8s-security deploy
```

### Assess Security

```bash
k8s-security assess
k8s-security assess unguard-payment-service
```

### Run Exploits

```bash
k8s-security exploit privileged-containers
k8s-security exploit-all
k8s-security interactive
```

### Apply Remediations

```bash
k8s-security secure
k8s-security secure-service payment
```

### Verify Improvements

```bash
k8s-security verify
```

## ‚ôüÔ∏è Advanced Usage

### Targeting specific services

```bash
# Assess a specific service
k8s-security assess unguard-payment-service

# Apply a specific vulnerability to a service
k8s-security vuln-service payment privileged

# Secure a specific service
k8s-security secure-service payment-service
```

### Enabling Debug Mode

```bash
# Enable debug mode for detailed logs
DEBUG=true k8s-security assess
```

### Running in Offline Mode

```bash
# Prepare offline resources
k8s-security prepare-offline

# Run security assessment in offline mode
OFFLINE_MODE=true k8s-security assess
```

## üß© Command Reference

| Command                  | Description                            |
|--------------------------|----------------------------------------|
| deploy                   | Deploy Unguard application             |
| assess [service]         | Assess security posture                |
| exploit \<type>          | Run specific exploit                   |
| exploit-all              | Run all exploits                       |
| secure [type]            | Apply security fixes                   |
| secure-service \<svc>    | Secure specific service                |
| rollback [service]       | Rollback changes                       |
| cleanup                  | Interactive cleanup menu               |

## Supported Exploits

- *privileged-containers*: Privileged mode exploitation.
- *dangerous-capabilities*: Linux capability abuse.
- *host-namespace-sharing*: Host namespace access.
- *missing-resource-limits*: Resource exhaustion.

## üõ°Ô∏è Safety Features

- **Namespace Isolation**: Operations target specific namespaces.
- **Confirmation Prompts**: Requires confirmation for destructive actions.
- **Rollback Support**: Undo changes with rollback.
- **Dry Run Mode**: Preview changes without applying them.
- **Educational Context**: Exploits are safe for demonstrations.

## üë∑‚Äç‚ôÇÔ∏è Troubleshooting

### Deployment Issues

```bash
# Check if the namespace exists
kubectl get namespace unguard

# Check if the pods are running
kubectl get pods -n unguard
```

### Exploits Not Working

```bash
# Ensure vulnerabilities are applied first
k8s-security vuln-service payment privileged

# Then run the exploit
k8s-security exploit privileged-containers
```

### Cleanup Issues

```bash
# Rollback all changes
k8s-security rollback

# Rollback a specific service
k8s-security rollback payment-service
```

## üåê Additional Resources

- [Kubernetes Security Documentation](https://kubernetes.io/docs/concepts/security/)
- [CIS Kubernetes Benchmark](https://www.cisecurity.org/benchmark/kubernetes)
- [NIST Container Security Guide](https://csrc.nist.gov/publications/detail/sp/800-190/final)
